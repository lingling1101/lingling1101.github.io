<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.127.0">
    <meta name="description" content="">
<meta name="author" content="journeyoftheaverageguy@gmail.com">

    <link rel="icon" href="/images/favicon.png" type="image/png">

    <title>Ongoing Load - ELT :: WORK WITH AMAZON SYSTEM MANAGER - SESSION MANAGER</title>

    
    <link href="/css/nucleus.css?1725804771" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css?1725804771" rel="stylesheet">
    <link href="/css/hybrid.css?1725804771" rel="stylesheet">
    <link href="/css/featherlight.min.css?1725804771" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1725804771" rel="stylesheet">
    <link href="/css/auto-complete.css?1725804771" rel="stylesheet">
    <link href="/css/atom-one-dark-reasonable.css?1725804771" rel="stylesheet">
    <link href="/css/theme.css?1725804771" rel="stylesheet">
    <link href="/css/hugo-theme.css?1725804771" rel="stylesheet">
    
    <link href="/css/theme-workshop.css?1725804771" rel="stylesheet">
    
    

    <script src="/js/jquery-3.3.1.min.js?1725804771"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    
  </head>
  <body class="" data-url="/3-ongoing-load---elt/">
    <nav id="sidebar" class="showVisitedLinks">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="/">

<svg id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 30" width="30%"><defs><style>.cls-1{fill:#fff;}.cls-2{fill:#f90;fill-rule:evenodd;}</style></defs><title>AWS-Logo_White-Color</title><path class="cls-1" d="M14.09,10.85a4.7,4.7,0,0,0,.19,1.48,7.73,7.73,0,0,0,.54,1.19.77.77,0,0,1,.12.38.64.64,0,0,1-.32.49l-1,.7a.83.83,0,0,1-.44.15.69.69,0,0,1-.49-.23,3.8,3.8,0,0,1-.6-.77q-.25-.42-.51-1a6.14,6.14,0,0,1-4.89,2.3,4.54,4.54,0,0,1-3.32-1.19,4.27,4.27,0,0,1-1.22-3.2A4.28,4.28,0,0,1,3.61,7.75,6.06,6.06,0,0,1,7.69,6.46a12.47,12.47,0,0,1,1.76.13q.92.13,1.91.36V5.73a3.65,3.65,0,0,0-.79-2.66A3.81,3.81,0,0,0,7.86,2.3a7.71,7.71,0,0,0-1.79.22,12.78,12.78,0,0,0-1.79.57,4.55,4.55,0,0,1-.58.22l-.26,0q-.35,0-.35-.52V2a1.09,1.09,0,0,1,.12-.58,1.2,1.2,0,0,1,.47-.35A10.88,10.88,0,0,1,5.77.32,10.19,10.19,0,0,1,8.36,0a6,6,0,0,1,4.35,1.35,5.49,5.49,0,0,1,1.38,4.09ZM7.34,13.38a5.36,5.36,0,0,0,1.72-.31A3.63,3.63,0,0,0,10.63,12,2.62,2.62,0,0,0,11.19,11a5.63,5.63,0,0,0,.16-1.44v-.7a14.35,14.35,0,0,0-1.53-.28,12.37,12.37,0,0,0-1.56-.1,3.84,3.84,0,0,0-2.47.67A2.34,2.34,0,0,0,5,11a2.35,2.35,0,0,0,.61,1.76A2.4,2.4,0,0,0,7.34,13.38Zm13.35,1.8a1,1,0,0,1-.64-.16,1.3,1.3,0,0,1-.35-.65L15.81,1.51a3,3,0,0,1-.15-.67.36.36,0,0,1,.41-.41H17.7a1,1,0,0,1,.65.16,1.4,1.4,0,0,1,.33.65l2.79,11,2.59-11A1.17,1.17,0,0,1,24.39.6a1.1,1.1,0,0,1,.67-.16H26.4a1.1,1.1,0,0,1,.67.16,1.17,1.17,0,0,1,.32.65L30,12.39,32.88,1.25A1.39,1.39,0,0,1,33.22.6a1,1,0,0,1,.65-.16h1.54a.36.36,0,0,1,.41.41,1.36,1.36,0,0,1,0,.26,3.64,3.64,0,0,1-.12.41l-4,12.86a1.3,1.3,0,0,1-.35.65,1,1,0,0,1-.64.16H29.25a1,1,0,0,1-.67-.17,1.26,1.26,0,0,1-.32-.67L25.67,3.64,23.11,14.34a1.26,1.26,0,0,1-.32.67,1,1,0,0,1-.67.17Zm21.36.44a11.28,11.28,0,0,1-2.56-.29,7.44,7.44,0,0,1-1.92-.67,1,1,0,0,1-.61-.93v-.84q0-.52.38-.52a.9.9,0,0,1,.31.06l.42.17a8.77,8.77,0,0,0,1.83.58,9.78,9.78,0,0,0,2,.2,4.48,4.48,0,0,0,2.43-.55,1.76,1.76,0,0,0,.86-1.57,1.61,1.61,0,0,0-.45-1.16A4.29,4.29,0,0,0,43,9.22l-2.41-.76A5.15,5.15,0,0,1,38,6.78a3.94,3.94,0,0,1-.83-2.41,3.7,3.7,0,0,1,.45-1.85,4.47,4.47,0,0,1,1.19-1.37A5.27,5.27,0,0,1,40.51.29,7.4,7.4,0,0,1,42.6,0a8.87,8.87,0,0,1,1.12.07q.57.07,1.08.19t.95.26a4.27,4.27,0,0,1,.7.29,1.59,1.59,0,0,1,.49.41.94.94,0,0,1,.15.55v.79q0,.52-.38.52a1.76,1.76,0,0,1-.64-.2,7.74,7.74,0,0,0-3.2-.64,4.37,4.37,0,0,0-2.21.47,1.6,1.6,0,0,0-.79,1.48,1.58,1.58,0,0,0,.49,1.18,4.94,4.94,0,0,0,1.83.92L44.55,7a5.08,5.08,0,0,1,2.57,1.6A3.76,3.76,0,0,1,47.9,11a4.21,4.21,0,0,1-.44,1.93,4.4,4.4,0,0,1-1.21,1.47,5.43,5.43,0,0,1-1.85.93A8.25,8.25,0,0,1,42.05,15.62Z"></path><path class="cls-2" d="M45.19,23.81C39.72,27.85,31.78,30,25,30A36.64,36.64,0,0,1,.22,20.57c-.51-.46-.06-1.09.56-.74A49.78,49.78,0,0,0,25.53,26.4,49.23,49.23,0,0,0,44.4,22.53C45.32,22.14,46.1,23.14,45.19,23.81Z"></path><path class="cls-2" d="M47.47,21.21c-.7-.9-4.63-.42-6.39-.21-.53.06-.62-.4-.14-.74,3.13-2.2,8.27-1.57,8.86-.83s-.16,5.89-3.09,8.35c-.45.38-.88.18-.68-.32C46.69,25.8,48.17,22.11,47.47,21.21Z"></path></svg>

</a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1725804771"></script>
<script type="text/javascript" src="/js/auto-complete.js?1725804771"></script>
<script type="text/javascript">
    
        var baseurl = "http:\/\/lingling1101.github.io\/";
    
</script>
<script type="text/javascript" src="/js/search.js?1725804771"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/1-getting-started/" title="Getting Started" class="dd-item 
        
        
        
        ">
      <a href="/1-getting-started/">
           <b> 1. </b> Getting Started
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/2-table-design-and-load/" title="Table Design and Load" class="dd-item 
        
        
        
        ">
      <a href="/2-table-design-and-load/">
           <b> 2. </b> Table Design and Load
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/3-ongoing-load---elt/" title="Ongoing Load - ELT" class="dd-item 
        
        active
        
        ">
      <a href="/3-ongoing-load---elt/">
           <b> 3. </b> Ongoing Load - ELT
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/4-data-sharing/" title="Data Sharing" class="dd-item 
        
        
        
        ">
      <a href="/4-data-sharing/">
           <b> 4. </b> Data Sharing
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/5-machine-learning---redshift-ml/" title="Machine Learning - Redshift ML" class="dd-item 
        
        
        
        ">
      <a href="/5-machine-learning---redshift-ml/">
           <b> 5. </b> Machine Learning - Redshift ML
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/6-query-data-lake---redshift-spectrum/" title="Query Data Lake - Redshift Spectrum" class="dd-item 
        
        
        
        ">
      <a href="/6-query-data-lake---redshift-spectrum/">
           <b> 6. </b> Query Data Lake - Redshift Spectrum
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/7-operations/" title="Operations" class="dd-item 
        
        
        
        ">
      <a href="/7-operations/">
           <b> 7. </b> Operations
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/8-clean/" title="Clean up resources" class="dd-item 
        
        
        
        ">
      <a href="/8-clean/">
           <b> 8. </b> Clean up resources
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
         
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li> 
                  <a class="padding" href="https://aws.amazon.com/blogs"><i class='fab fa-aws'></i> AWS Study Group - Blog</a>
              </li>
          
              <li> 
                  <a class="padding" href="https://www.facebook.com/groups/awsstudygroupfcj"><i class='fab fa-facebook'></i> AWS Study Group - FB Group</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="prefooter">
      <hr/>
      <ul>
      
        <li>
          <a class="padding">
            <i class="fas fa-language fa-fw"></i>
          <div class="select-style">
            <select id="select-language" onchange="location = this.value;">
          
          
          
              
              
                  
                    
                    
                      <option id="en" value="http://lingling1101.github.io/3-ongoing-load---elt/" selected>English</option>
                    
                  
              
                  
              
          
              
              
                  
              
                  
                    
                    
                      <option id="vi" value="http://lingling1101.github.io/vi/3-ongoing-load---elt/">Tiếng Việt</option>
                    
                  
              
          
        </select>
        <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
          width="255px" height="255px" viewBox="0 0 255 255" style="enable-background:new 0 0 255 255;" xml:space="preserve">
          <g>
            <g id="arrow-drop-down">
              <polygon points="0,63.75 127.5,191.25 255,63.75 		" />
            </g>
          </g>
        </svg>
        </div>
        </a>
        </li>
      
      
      
        <li><a class="padding" href="#" data-clear-history-toggle=""><i class="fas fa-history fa-fw"></i> Clear History</a></li>
      
      </ul>
    </section>
    
    <section id="footer">
      <left>
    
     <b> Workshop</b> <br>
    <img src="https://hitwebcounter.com/counter/counter.php?page=7920860&style=0038&nbdigits=9&type=page&initCount=0" title="Migrate" Alt="web counter"   border="0" /></a>  <br>
     <b> <a href="https://cloudjourney.awsstudygroup.com/">Cloud Journey</a></b> <br>
    <img src="https://hitwebcounter.com/counter/counter.php?page=7830807&style=0038&nbdigits=9&type=page&initCount=0" title="Total CLoud Journey" Alt="web counter"   border="0"   />
     
</left>
<left>
    <br>
    <br>
        <b> Last Updated </b> <br>
        <i><font color=orange>31-08-2024</font></i>
    </left>
    <left>
        <br>
        <br>
            <b> Team </b> <br>
           
            <i> <a href="https://drive.google.com/drive/folders/1-JDjxDuFFq9Xwszz7REZ_kDzWDPtM1XS?usp=sharing"  style="color:orange">Nguyễn Thị Thùy Linh  </a> <br>
                
               
        </i>
        </left>

<script async defer src="https://buttons.github.io/buttons.js"></script>

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            <a href='/'>Redshift Immersion Labs</a> > Ongoing Load - ELT
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents"></nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Ongoing Load - ELT
            </h1>
          

        



	<p><strong>3. Ongoing Load - ELT</strong></p>
<p><strong>Contents</strong></p>
<ul>
<li>Before you begin</li>
<li>Stored procedures - Ongoing loads</li>
<li>Stored procedures - Exception handling</li>
<li>Materialized views</li>
<li>User defined functions</li>
<li>Before you leave</li>
</ul>
<p><strong>3.1 Before you begin</strong></p>
<p>This lab assumes that you have launched an Amazon Redshift Serverless endpoint. If you have not already done so, please see Getting Started and follow the instructions there. We will use Amazon Redshift QueryEditorV2  for this lab.</p>
<p>With ETL, data transformation happens in a middle-tier ETL server before loading it on the Data Warehouse. The following diagram illustrates the ETL workflow:</p>
<p><img alt="image.png" src="/images/3/3-1.png"></p>
<p>With ELT, data transformation happens in the target data warehouse rather than requiring a middle-tier ETL server. This approach takes advantage of Redshift database engines that support massively parallel processing (MPP). The following diagram illustrates the ELT workflow:</p>
<p><img alt="image.png" src="/images/3/3-2.png"></p>
<p><strong>3.2 Stored Procedures - Ongoing loads</strong></p>
<p>Stored procedures are commonly used to encapsulate logic for data transformation, data validation, and business-specific logic. By combining multiple SQL steps into a stored procedure, you can reduce round trips between your applications and the database. A stored procedure can incorporate data definition language (DDL) and data manipulation language (DML) in addition to SELECT queries. A stored procedure doesn’t have to return a value. You can use the PL/pgSQL procedural language, including looping and conditional expressions, to control logical flow.</p>
<p>Let’s see how you can create and invoke stored procedure in Redshift. Here our goal is to incrementally refresh the lineitem data. Execute the following query to create lineitem staging table:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">create</span> <span style="color:#a6e22e">table</span> <span style="color:#a6e22e">stage_lineitem</span> (
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">L_ORDERKEY</span> <span style="color:#a6e22e">bigint</span> <span style="color:#a6e22e">NOT</span> <span style="color:#a6e22e">NULL</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">L_PARTKEY</span> <span style="color:#a6e22e">bigint</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">L_SUPPKEY</span> <span style="color:#a6e22e">bigint</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">L_LINENUMBER</span> <span style="color:#a6e22e">integer</span> <span style="color:#a6e22e">NOT</span> <span style="color:#a6e22e">NULL</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">L_QUANTITY</span> <span style="color:#a6e22e">decimal</span>(<span style="color:#ae81ff">18</span>,<span style="color:#ae81ff">4</span>),
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">L_EXTENDEDPRICE</span> <span style="color:#a6e22e">decimal</span>(<span style="color:#ae81ff">18</span>,<span style="color:#ae81ff">4</span>),
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">L_DISCOUNT</span> <span style="color:#a6e22e">decimal</span>(<span style="color:#ae81ff">18</span>,<span style="color:#ae81ff">4</span>),
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">L_TAX</span> <span style="color:#a6e22e">decimal</span>(<span style="color:#ae81ff">18</span>,<span style="color:#ae81ff">4</span>),
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">L_RETURNFLAG</span> <span style="color:#a6e22e">varchar</span>(<span style="color:#ae81ff">1</span>),
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">L_LINESTATUS</span> <span style="color:#a6e22e">varchar</span>(<span style="color:#ae81ff">1</span>),
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">L_SHIPDATE</span> <span style="color:#a6e22e">date</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">L_COMMITDATE</span> <span style="color:#a6e22e">date</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">L_RECEIPTDATE</span> <span style="color:#a6e22e">date</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">L_SHIPINSTRUCT</span> <span style="color:#a6e22e">varchar</span>(<span style="color:#ae81ff">25</span>),
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">L_SHIPMODE</span> <span style="color:#a6e22e">varchar</span>(<span style="color:#ae81ff">10</span>),
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">L_COMMENT</span> <span style="color:#a6e22e">varchar</span>(<span style="color:#ae81ff">44</span>));
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-33.png"></p>
<p>Execute below script to create a stored procedure. This stored procedure performs following tasks:</p>
<ol>
<li>Truncate staging table to clean up old data</li>
<li>Load data in the <code>stage_lineitem</code> table using the <code>COPY</code> command.</li>
<li>Merge updated records in existing <code>lineitem</code> table. The <code>MERGE</code>  function will update the target table based on the new data in the staging table.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">CREATE</span> <span style="color:#a6e22e">OR</span> <span style="color:#a6e22e">REPLACE</span> <span style="color:#a6e22e">PROCEDURE</span> <span style="color:#a6e22e">lineitem_incremental</span>()
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">AS</span> <span style="color:#a6e22e">$$</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">BEGIN</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">truncate</span> <span style="color:#a6e22e">stage_lineitem</span>;  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">copy</span> <span style="color:#a6e22e">stage_lineitem</span> <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;s3://redshift-immersionday-labs/data/lineitem/lineitem.tbl.340.lzo&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">iam_role</span> <span style="color:#66d9ef">default</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">region</span> <span style="color:#e6db74">&#39;us-west-2&#39;</span> <span style="color:#a6e22e">lzop</span> <span style="color:#a6e22e">delimiter</span> <span style="color:#e6db74">&#39;|&#39;</span> <span style="color:#a6e22e">COMPUPDATE</span> <span style="color:#a6e22e">PRESET</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">copy</span> <span style="color:#a6e22e">stage_lineitem</span> <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;s3://redshift-immersionday-labs/data/lineitem/lineitem.tbl.341.lzo&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">iam_role</span> <span style="color:#66d9ef">default</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">region</span> <span style="color:#e6db74">&#39;us-west-2&#39;</span> <span style="color:#a6e22e">lzop</span> <span style="color:#a6e22e">delimiter</span> <span style="color:#e6db74">&#39;|&#39;</span> <span style="color:#a6e22e">COMPUPDATE</span> <span style="color:#a6e22e">PRESET</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">copy</span> <span style="color:#a6e22e">stage_lineitem</span> <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;s3://redshift-immersionday-labs/data/lineitem/lineitem.tbl.342.lzo&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">iam_role</span> <span style="color:#66d9ef">default</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">region</span> <span style="color:#e6db74">&#39;us-west-2&#39;</span> <span style="color:#a6e22e">lzop</span> <span style="color:#a6e22e">delimiter</span> <span style="color:#e6db74">&#39;|&#39;</span> <span style="color:#a6e22e">COMPUPDATE</span> <span style="color:#a6e22e">PRESET</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">merge</span> <span style="color:#a6e22e">into</span> <span style="color:#a6e22e">lineitem</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">using</span> <span style="color:#a6e22e">stage_lineitem</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">on</span> <span style="color:#a6e22e">stage_lineitem</span>.<span style="color:#a6e22e">l_orderkey</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">lineitem</span>.<span style="color:#a6e22e">l_orderkey</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">and</span> <span style="color:#a6e22e">stage_lineitem</span>.<span style="color:#a6e22e">l_linenumber</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">lineitem</span>.<span style="color:#a6e22e">l_linenumber</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">remove</span> <span style="color:#a6e22e">duplicates</span>
</span></span><span style="display:flex;"><span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">END</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">$$</span> <span style="color:#a6e22e">LANGUAGE</span> <span style="color:#a6e22e">plpgsql</span>;
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-44.png"></p>
<p>Before you call this stored procedure, capture total #rows from lineitem table</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">SELECT</span> <span style="color:#a6e22e">count</span>(<span style="color:#f92672">*</span>) <span style="color:#a6e22e">FROM</span> <span style="color:#e6db74">&#34;dev&#34;</span>.<span style="color:#e6db74">&#34;public&#34;</span>.<span style="color:#e6db74">&#34;lineitem&#34;</span>; <span style="color:#f92672">--</span><span style="color:#ae81ff">303008217</span>
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-5.png"></p>
<p>Call this stored procedure using CALL statement. When executed it will perform an incremental load:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">call</span> <span style="color:#a6e22e">lineitem_incremental</span>();
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-6.png"></p>
<p>After you call this stored procedure, verify total #rows from lineitem table has changed</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">SELECT</span> <span style="color:#a6e22e">count</span>(<span style="color:#f92672">*</span>) <span style="color:#a6e22e">FROM</span> <span style="color:#e6db74">&#34;dev&#34;</span>.<span style="color:#e6db74">&#34;public&#34;</span>.<span style="color:#e6db74">&#34;lineitem&#34;</span>; <span style="color:#f92672">--</span><span style="color:#ae81ff">306008217</span>
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-7.png"></p>
<p><strong>3.3 Stored Procedures - Exception Handling</strong></p>
<p>This next section covers exception handling within stored procedures. Stored procedures support exception handling in the following format:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">Example</span> <span style="color:#a6e22e">pseudocode</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">BEGIN</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">statements</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">EXCEPTION</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">WHEN</span> <span style="color:#a6e22e">OTHERS</span> <span style="color:#a6e22e">THEN</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">statements</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">END</span>;
</span></span></code></pre></div><p>Exceptions are handled in stored procedures differently based on the atomic or non-atomic mode chosen.</p>
<ul>
<li><strong>Atomic (default):</strong> exceptions (errors) are always re-raised</li>
<li><strong>Non-atomic:</strong> exceptions are handled and you can choose to re-raise or not</li>
</ul>
<p><strong>Note:</strong> When calling a stored procedure from another, the stored procedures must have matching transaction modes or else you will see the following error: Stored procedure created in one transaction mode cannot be invoked from another procedure in a different transaction mode</p>
<p>To get started, we need to first create a table for the stored procedures in this section.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">CREATE</span> <span style="color:#a6e22e">TABLE</span> <span style="color:#a6e22e">stage_lineitem2</span> (<span style="color:#a6e22e">LIKE</span> <span style="color:#a6e22e">stage_lineitem</span>);
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-88.png"></p>
<p>Next, we will create a table that will capture the error messages.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">CREATE</span> <span style="color:#a6e22e">TABLE</span> <span style="color:#a6e22e">procedure_log</span>
</span></span><span style="display:flex;"><span>(<span style="color:#a6e22e">log_timestamp</span> <span style="color:#a6e22e">timestamp</span>, <span style="color:#a6e22e">procedure_name</span> <span style="color:#a6e22e">varchar</span>(<span style="color:#ae81ff">100</span>), <span style="color:#a6e22e">error_message</span> <span style="color:#a6e22e">varchar</span>(<span style="color:#ae81ff">255</span>));
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-99.png"></p>
<p><strong>3.4 Atomic</strong></p>
<p>Stored procedures in Redshift are atomic by default which means you have transaction control for the statements in the procedure. If you choose to not include COMMIT or ROLLBACK in the stored procedure, then all statements are handled in a single transaction. It is important to know that in the default atomic mode, exceptions are always re-raised.</p>
<pre tabindex="0"><code>COMMIT
</code></pre><p>or</p>
<pre tabindex="0"><code>ROLLBACK
</code></pre><p>in the stored procedure, then all statements are handled in a single transaction. It is important to know that in the default atomic mode, exceptions are always re-raised.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">CREATE</span> <span style="color:#a6e22e">OR</span> <span style="color:#a6e22e">REPLACE</span> <span style="color:#a6e22e">PROCEDURE</span> <span style="color:#a6e22e">pr_divide_by_zero</span>() <span style="color:#a6e22e">AS</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">$$</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">DECLARE</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">v_int</span> <span style="color:#66d9ef">int</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">BEGIN</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">v_int</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">EXCEPTION</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">WHEN</span> <span style="color:#a6e22e">OTHERS</span> <span style="color:#a6e22e">THEN</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">INSERT</span> <span style="color:#a6e22e">INTO</span> <span style="color:#a6e22e">procedure_log</span> <span style="color:#a6e22e">VALUES</span> (<span style="color:#a6e22e">getdate</span>(), <span style="color:#e6db74">&#39;pr_divide_by_zero&#39;</span>, <span style="color:#a6e22e">sqlerrm</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">RAISE</span> <span style="color:#a6e22e">INFO</span> <span style="color:#e6db74">&#39;pr_divide_by_zero: %&#39;</span>, <span style="color:#a6e22e">sqlerrm</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">END</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">$$</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">LANGUAGE</span> <span style="color:#a6e22e">plpgsql</span>;
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-010.png"></p>
<p>The above stored procedure is designed to fail with a division by zero error. The exception handling in this stored procedure stores the error message in the procedure_log table and then executes a RAISE INFO so the calling procedure is aware of the error. Because this is an atomic procedure, this will cause a re-raise of the error even though the exception block doesn&rsquo;t raise an error. It raises an INFO but Redshift overrides this in the default mode and an ERROR is raised.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">CREATE</span> <span style="color:#a6e22e">OR</span> <span style="color:#a6e22e">REPLACE</span> <span style="color:#a6e22e">PROCEDURE</span> <span style="color:#a6e22e">pr_insert_stage</span>() <span style="color:#a6e22e">AS</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">$$</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">BEGIN</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">TRUNCATE</span> <span style="color:#a6e22e">stage_lineitem2</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">INSERT</span> <span style="color:#a6e22e">INTO</span> <span style="color:#a6e22e">stage_lineitem2</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">FROM</span> <span style="color:#a6e22e">stage_lineitem</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">call</span> <span style="color:#a6e22e">pr_divide_by_zero</span>();
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">EXCEPTION</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">WHEN</span> <span style="color:#a6e22e">OTHERS</span> <span style="color:#a6e22e">THEN</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">RAISE</span> <span style="color:#a6e22e">EXCEPTION</span> <span style="color:#e6db74">&#39;pr_insert_stage: %&#39;</span>, <span style="color:#a6e22e">sqlerrm</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">END</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">$$</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">LANGUAGE</span> <span style="color:#a6e22e">plpgsql</span>;
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-011.png"></p>
<p>This second stored procedure inserts data into the stage_lineitem2 table and then calls the procedure that will fail by design.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">CALL</span> <span style="color:#a6e22e">pr_insert_stage</span>();
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-012.png"></p>
<p>You should see two messages:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">INFO</span><span style="color:#f92672">:</span>  <span style="color:#a6e22e">pr_divide_by_zero</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">division</span> <span style="color:#a6e22e">by</span> <span style="color:#a6e22e">zero</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ERROR</span><span style="color:#f92672">:</span>  <span style="color:#a6e22e">pr_insert_stage</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">division</span> <span style="color:#a6e22e">by</span> <span style="color:#a6e22e">zero</span>
</span></span></code></pre></div><p>Notice that the INFO message is from <code>pr_divide_by_zero</code> while the ERROR is from <code>pr_insert_stage</code>. The error was automatically re-raised so <code>pr_insert_stage(</code> raises an ERROR.</p>
<p>Now, check the number of rows in <code>stage_lineitem2</code>;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">SELECT</span> <span style="color:#a6e22e">COUNT</span>(<span style="color:#f92672">*</span>) <span style="color:#a6e22e">FROM</span> <span style="color:#a6e22e">stage_lineitem2</span>;
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-13.png"></p>
<p>Because the stored procedure is atomic, the data inserted into the stage table is rolled back because of the subsequent error so the number of rows in <code>stage_lineitem2</code> is zero.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">FROM</span> <span style="color:#a6e22e">procedure_log</span> <span style="color:#a6e22e">ORDER</span> <span style="color:#a6e22e">BY</span> <span style="color:#a6e22e">log_timestamp</span> <span style="color:#a6e22e">DESC</span>;
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-014.png"></p>
<p>You should see that the pr_divide_by_zero procedure error was captured in the exception block.</p>
<p><strong>3.5 Non-atomic</strong></p>
<p>Stored procedures can also be created with the <code>NONATOMIC</code> option which will automatically <code>COMMIT</code> after each statement. When an ERROR exception happens in a stored procedure, the exception is not always re-raised. Instead, you can choose to &ldquo;handle&rdquo; the error and continue subsequent statements in the stored procedure.</p>
<p>The following stored procedures are identical to the atomic versions except each now includes the <code>NONATOMIC</code> option. This mode automatically commits the statements inside the procedure and doesn&rsquo;t automatically re-raise errors.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">CREATE</span> <span style="color:#a6e22e">OR</span> <span style="color:#a6e22e">REPLACE</span> <span style="color:#a6e22e">PROCEDURE</span> <span style="color:#a6e22e">pr_divide_by_zero_v2</span>() <span style="color:#a6e22e">NONATOMIC</span> <span style="color:#a6e22e">AS</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">$$</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">DECLARE</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">v_int</span> <span style="color:#66d9ef">int</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">BEGIN</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">v_int</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">EXCEPTION</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">WHEN</span> <span style="color:#a6e22e">OTHERS</span> <span style="color:#a6e22e">THEN</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">INSERT</span> <span style="color:#a6e22e">INTO</span> <span style="color:#a6e22e">procedure_log</span> <span style="color:#a6e22e">VALUES</span> (<span style="color:#a6e22e">getdate</span>(), <span style="color:#e6db74">&#39;pr_divide_by_zero_v2&#39;</span>, <span style="color:#a6e22e">sqlerrm</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">RAISE</span> <span style="color:#a6e22e">INFO</span> <span style="color:#e6db74">&#39;pr_divide_by_zero_v2: %&#39;</span>, <span style="color:#a6e22e">sqlerrm</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">END</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">$$</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">LANGUAGE</span> <span style="color:#a6e22e">plpgsql</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">CREATE</span> <span style="color:#a6e22e">OR</span> <span style="color:#a6e22e">REPLACE</span> <span style="color:#a6e22e">PROCEDURE</span> <span style="color:#a6e22e">pr_insert_stage_v2</span>() <span style="color:#a6e22e">NONATOMIC</span> <span style="color:#a6e22e">AS</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">$$</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">BEGIN</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">TRUNCATE</span> <span style="color:#a6e22e">stage_lineitem2</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">INSERT</span> <span style="color:#a6e22e">INTO</span> <span style="color:#a6e22e">stage_lineitem2</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">FROM</span> <span style="color:#a6e22e">stage_lineitem</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">call</span> <span style="color:#a6e22e">pr_divide_by_zero_v2</span>();
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">EXCEPTION</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">WHEN</span> <span style="color:#a6e22e">OTHERS</span> <span style="color:#a6e22e">THEN</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">RAISE</span> <span style="color:#a6e22e">EXCEPTION</span> <span style="color:#e6db74">&#39;pr_insert_stage_v2: %&#39;</span>, <span style="color:#a6e22e">sqlerrm</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">END</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">$$</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">LANGUAGE</span> <span style="color:#a6e22e">plpgsql</span>;
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-015.png"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">CALL</span> <span style="color:#a6e22e">pr_insert_stage_v2</span>();
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-16.png"></p>
<p>You should see one message:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">INFO</span><span style="color:#f92672">:</span>  <span style="color:#a6e22e">pr_divide_by_zero</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">division</span> <span style="color:#a6e22e">by</span> <span style="color:#a6e22e">zero</span>
</span></span></code></pre></div><p>Remember that in the default atomic mode, you saw two messages where in this mode, the ERROR was handled and the exception wasn&rsquo;t re-raised.</p>
<p>Now, check the number of rows in <code>stage_lineitem2</code>;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">SELECT</span> <span style="color:#a6e22e">COUNT</span>(<span style="color:#f92672">*</span>) <span style="color:#a6e22e">FROM</span> <span style="color:#a6e22e">stage_lineitem2</span>;
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-017.png"></p>
<p>Because the stored procedure is non-atomic, the data inserted into the table are not rolled back. The insert statement was automatically committed. The number of rows in <code>stage_lineitem2</code> is 4155141.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">FROM</span> <span style="color:#a6e22e">procedure_log</span> <span style="color:#a6e22e">ORDER</span> <span style="color:#a6e22e">BY</span> <span style="color:#a6e22e">log_timestamp</span> <span style="color:#a6e22e">DESC</span>;
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-018.png"></p>
<p>You should see that the pr_divide_by_zero_v2 procedure error was captured in the exception block just like in the atomic version.</p>
<p><strong>3.6 Materialized Views</strong></p>
<p>In a data warehouse environment, applications often need to perform complex queries on large tables—for example, SELECT statements that perform multi-table joins and aggregations on the tables that contain billions of rows. Processing these queries can be expensive in terms of system resources and the time it takes to compute the results.</p>
<p>Materialized views in Amazon Redshift provide a way to address these issues. A materialized view contains a precomputed result set, based on SQL query over one or more base tables. Here you will learn how to create, query and refresh a materialized view.</p>
<p>Let’s take an example where you want to generate a report of the top suppliers by shipped quantity. This will join large tables like and <code>lineitem</code>, and <code>suppliers</code> and scan a large quantity of data. You might write a query like the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">select</span> <span style="color:#a6e22e">n_name</span>, <span style="color:#a6e22e">s_name</span>, <span style="color:#a6e22e">l_shipmode</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">SUM</span>(<span style="color:#a6e22e">L_QUANTITY</span>) <span style="color:#a6e22e">Total_Qty</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">from</span> <span style="color:#a6e22e">lineitem</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">join</span> <span style="color:#a6e22e">supplier</span> <span style="color:#a6e22e">on</span> <span style="color:#a6e22e">l_suppkey</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_suppkey</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">join</span> <span style="color:#a6e22e">nation</span> <span style="color:#a6e22e">on</span> <span style="color:#a6e22e">s_nationkey</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">n_nationkey</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">where</span> <span style="color:#a6e22e">datepart</span>(<span style="color:#a6e22e">year</span>, <span style="color:#a6e22e">L_SHIPDATE</span>) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1997</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">group</span> <span style="color:#a6e22e">by</span> <span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">order</span> <span style="color:#a6e22e">by</span> <span style="color:#ae81ff">3</span> <span style="color:#a6e22e">desc</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">limit</span> <span style="color:#ae81ff">1000</span>;
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-19.png"></p>
<p>This query takes time to execute and because it is scanning a large amount of data will use a lot of I/O &amp; CPU resources. Think of a situation, where multiple users in the organization need get supplier-level metrics like the above. Each may write similarly heavy queries which can be time consuming and expensive operations. Instead of that you can use a materialized view to store precomputed results for speeding up queries that are predictable and repeated.</p>
<p>Amazon Redshift provides a few methods to keep materialized views up-to-date. You can configure the automatic refresh option to refresh materialized views when base tables of mare updated. The auto refresh operation runs at a time when cluster resources are available to minimize disruptions to other workloads.</p>
<p>Execute below query to create materialized view which aggregates the lineitem data to the supplier level. Note, the <code>AUTO REFRESH</code> option is set to YES and we&rsquo;ve included additional columns in our MV in case other users can take advantage of this aggregated data.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">CREATE</span> <span style="color:#a6e22e">MATERIALIZED</span> <span style="color:#a6e22e">VIEW</span> <span style="color:#a6e22e">supplier_shipmode_agg</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">AUTO</span> <span style="color:#a6e22e">REFRESH</span> <span style="color:#a6e22e">YES</span> <span style="color:#a6e22e">AS</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">select</span> <span style="color:#a6e22e">l_suppkey</span>, <span style="color:#a6e22e">l_shipmode</span>, <span style="color:#a6e22e">datepart</span>(<span style="color:#a6e22e">year</span>, <span style="color:#a6e22e">L_SHIPDATE</span>) <span style="color:#a6e22e">l_shipyear</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">SUM</span>(<span style="color:#a6e22e">L_QUANTITY</span>)	<span style="color:#a6e22e">TOTAL_QTY</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">SUM</span>(<span style="color:#a6e22e">L_DISCOUNT</span>) <span style="color:#a6e22e">TOTAL_DISCOUNT</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">SUM</span>(<span style="color:#a6e22e">L_TAX</span>) <span style="color:#a6e22e">TOTAL_TAX</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">SUM</span>(<span style="color:#a6e22e">L_EXTENDEDPRICE</span>) <span style="color:#a6e22e">TOTAL_EXTENDEDPRICE</span>  
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">from</span> <span style="color:#a6e22e">LINEITEM</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">group</span> <span style="color:#a6e22e">by</span> <span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span>;
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-0020.png"></p>
<p>Now execute the below query which has been re-written to use the materialized view. Note the difference in query execution time. You get the same results in few seconds.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">select</span> <span style="color:#a6e22e">n_name</span>, <span style="color:#a6e22e">s_name</span>, <span style="color:#a6e22e">l_shipmode</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">SUM</span>(<span style="color:#a6e22e">TOTAL_QTY</span>) <span style="color:#a6e22e">Total_Qty</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">from</span> <span style="color:#a6e22e">supplier_shipmode_agg</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">join</span> <span style="color:#a6e22e">supplier</span> <span style="color:#a6e22e">on</span> <span style="color:#a6e22e">l_suppkey</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_suppkey</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">join</span> <span style="color:#a6e22e">nation</span> <span style="color:#a6e22e">on</span> <span style="color:#a6e22e">s_nationkey</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">n_nationkey</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">where</span> <span style="color:#a6e22e">l_shipyear</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1997</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">group</span> <span style="color:#a6e22e">by</span> <span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">order</span> <span style="color:#a6e22e">by</span> <span style="color:#ae81ff">3</span> <span style="color:#a6e22e">desc</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">limit</span> <span style="color:#ae81ff">1000</span>;
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-21.png"></p>
<p>Another powerful feature of Materialized view is auto query rewrite. Amazon Redshift can automatically rewrite queries to use materialized views, even when the query doesn&rsquo;t explicitly reference a materialized view.</p>
<p>Now, re-run your original query which references the lineitem table and see this query now executes faster because Redshift has re-written this query to leverage the materialized view instead of base table.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">select</span> <span style="color:#a6e22e">n_name</span>, <span style="color:#a6e22e">s_name</span>, <span style="color:#a6e22e">l_shipmode</span>, <span style="color:#a6e22e">SUM</span>(<span style="color:#a6e22e">L_QUANTITY</span>) <span style="color:#a6e22e">Total_Qty</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">from</span> <span style="color:#a6e22e">lineitem</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">join</span> <span style="color:#a6e22e">supplier</span> <span style="color:#a6e22e">on</span> <span style="color:#a6e22e">l_suppkey</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_suppkey</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">join</span> <span style="color:#a6e22e">nation</span> <span style="color:#a6e22e">on</span> <span style="color:#a6e22e">s_nationkey</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">n_nationkey</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">where</span> <span style="color:#a6e22e">datepart</span>(<span style="color:#a6e22e">year</span>, <span style="color:#a6e22e">L_SHIPDATE</span>) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1997</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">group</span> <span style="color:#a6e22e">by</span> <span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">order</span> <span style="color:#a6e22e">by</span> <span style="color:#ae81ff">3</span> <span style="color:#a6e22e">desc</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">limit</span> <span style="color:#ae81ff">1000</span>;
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-22.png"></p>
<p>You can verify that the query re-writer is using the MV by running an explain operation:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">explain</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">select</span> <span style="color:#a6e22e">n_name</span>, <span style="color:#a6e22e">s_name</span>, <span style="color:#a6e22e">l_shipmode</span>, <span style="color:#a6e22e">SUM</span>(<span style="color:#a6e22e">L_QUANTITY</span>) <span style="color:#a6e22e">Total_Qty</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">from</span> <span style="color:#a6e22e">lineitem</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">join</span> <span style="color:#a6e22e">supplier</span> <span style="color:#a6e22e">on</span> <span style="color:#a6e22e">l_suppkey</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_suppkey</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">join</span> <span style="color:#a6e22e">nation</span> <span style="color:#a6e22e">on</span> <span style="color:#a6e22e">s_nationkey</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">n_nationkey</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">where</span> <span style="color:#a6e22e">datepart</span>(<span style="color:#a6e22e">year</span>, <span style="color:#a6e22e">L_SHIPDATE</span>) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1997</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">group</span> <span style="color:#a6e22e">by</span> <span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">order</span> <span style="color:#a6e22e">by</span> <span style="color:#ae81ff">3</span> <span style="color:#a6e22e">desc</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">limit</span> <span style="color:#ae81ff">1000</span>;
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-23.png"></p>
<p><img alt="image.png" src="/images/3/3-232.png"></p>
<blockquote>
<p>Write additional queries which can leverage your materialized view but which do not directly reference it. For example, Total Extendedprice by Region.</p>
</blockquote>
<p><strong>3.7 Bringing it together</strong></p>
<p>Let’s see if Redshift is automatically refresh materialized view after lineitem table Data Changes.</p>
<p>Please capture a metric using the materialized view. We&rsquo;ll compare this value after base table data changes.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">select</span> <span style="color:#a6e22e">SUM</span>(<span style="color:#a6e22e">TOTAL_QTY</span>) <span style="color:#a6e22e">Total_Qty</span> <span style="color:#a6e22e">from</span> <span style="color:#a6e22e">supplier_shipmode_agg</span>;
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-24.png"></p>
<p>let&rsquo;s delete some previously loaded data from the <em>lineitem</em> table.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#66d9ef">delete</span> <span style="color:#a6e22e">from</span> <span style="color:#a6e22e">lineitem</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">using</span> <span style="color:#a6e22e">orders</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">where</span> <span style="color:#a6e22e">l_orderkey</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">o_orderkey</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">and</span> <span style="color:#a6e22e">datepart</span>(<span style="color:#a6e22e">year</span>, <span style="color:#a6e22e">o_orderdate</span>) <span style="color:#f92672">=</span> <span style="color:#ae81ff">1998</span> <span style="color:#a6e22e">and</span> <span style="color:#a6e22e">datepart</span>(<span style="color:#a6e22e">month</span>, <span style="color:#a6e22e">o_orderdate</span>) <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>;
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-25.png"></p>
<p>Run the below queries on the MV and compare with the value you had noted previously. You will see SUM has changed which indicates that Redshift has identified changes that have taken place in the base table or tables, and then applied those changes to the materialized view.</p>
<p><strong>Notion:</strong> the materialized view refresh is asynchronous. For this lab, expect ~5min for the data to be refreshed after you called the <code>lineitem_incremental</code> procedure:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">select</span> <span style="color:#a6e22e">SUM</span>(<span style="color:#a6e22e">TOTAL_QTY</span>) <span style="color:#a6e22e">Total_Qty</span> <span style="color:#a6e22e">from</span> <span style="color:#a6e22e">supplier_shipmode_agg</span>;
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-26.png"></p>
<p><strong>3.8 User Defined Functions</strong></p>
<p>Redshift supports scalar user-defined function (UDF) using either a SQL SELECT clause or a Python program. The following example creates a Python function that compares two numbers and returns the larger value:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">create</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">f_py_greater</span> (<span style="color:#a6e22e">a</span> <span style="color:#66d9ef">float</span>, <span style="color:#a6e22e">b</span> <span style="color:#66d9ef">float</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">returns</span> <span style="color:#66d9ef">float</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">stable</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">as</span> <span style="color:#a6e22e">$$</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">a</span> <span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">b</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">a</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">b</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">$$</span> <span style="color:#a6e22e">language</span> <span style="color:#a6e22e">plpythonu</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">select</span> <span style="color:#a6e22e">f_py_greater</span> (<span style="color:#a6e22e">l_extendedprice</span>, <span style="color:#a6e22e">l_discount</span>) <span style="color:#a6e22e">from</span> <span style="color:#a6e22e">lineitem</span> <span style="color:#a6e22e">limit</span> <span style="color:#ae81ff">10</span>
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-272.png">
<img alt="image.png" src="/images/3/3-27.png"></p>
<p>The following example creates a SQL function that compares two numbers and returns the larger value:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">create</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">f_sql_greater</span> (<span style="color:#66d9ef">float</span>, <span style="color:#66d9ef">float</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">returns</span> <span style="color:#66d9ef">float</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">stable</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">as</span> <span style="color:#a6e22e">$$</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">select</span> <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">when</span> <span style="color:#a6e22e">$1</span> <span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">$2</span> <span style="color:#a6e22e">then</span> <span style="color:#a6e22e">$1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">$2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">end</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">$$</span> <span style="color:#a6e22e">language</span> <span style="color:#a6e22e">sql</span>;  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">select</span> <span style="color:#a6e22e">f_sql_greater</span> (<span style="color:#a6e22e">l_extendedprice</span>, <span style="color:#a6e22e">l_discount</span>) <span style="color:#a6e22e">from</span> <span style="color:#a6e22e">lineitem</span> <span style="color:#a6e22e">limit</span> <span style="color:#ae81ff">10</span>
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-28.png"></p>





<footer class=" footline" >
	
</footer>

        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
        
        


	 
	 
		
			<a class="nav nav-prev" href="/2-table-design-and-load/" title="Table Design and Load"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="/4-data-sharing/" title="Data Sharing" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1725804771"></script>
    <script src="/js/perfect-scrollbar.min.js?1725804771"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1725804771"></script>
    <script src="/js/jquery.sticky.js?1725804771"></script>
    <script src="/js/featherlight.min.js?1725804771"></script>
    <script src="/js/highlight.pack.js?1725804771"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom-3.6.0.js?1725804771"></script>
    <script src="/js/learn.js?1725804771"></script>
    <script src="/js/hugo-learn.js?1725804771"></script>

    <link href="/mermaid/mermaid.css?1725804771" rel="stylesheet" />
    <script src="/mermaid/mermaid.js?1725804771"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-158079754-2', 'auto');
  ga('send', 'pageview');

</script>
  </body>
</html>
