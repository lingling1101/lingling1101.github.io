<!DOCTYPE html>
<html lang="vi" class="js csstransforms3d">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.127.0">
    <meta name="description" content="">
<meta name="author" content="journeyoftheaverageguy@gmail.com">

    <link rel="icon" href="/images/favicon.png" type="image/png">

    <title>Tải dữ liệu liên tục - ELT :: LÀM VIỆC VỚI AMAZON SYSTEM MANAGER - SESSION MANAGER</title>

    
    <link href="/css/nucleus.css?1726390283" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css?1726390283" rel="stylesheet">
    <link href="/css/hybrid.css?1726390283" rel="stylesheet">
    <link href="/css/featherlight.min.css?1726390283" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1726390283" rel="stylesheet">
    <link href="/css/auto-complete.css?1726390283" rel="stylesheet">
    <link href="/css/atom-one-dark-reasonable.css?1726390283" rel="stylesheet">
    <link href="/css/theme.css?1726390283" rel="stylesheet">
    <link href="/css/hugo-theme.css?1726390283" rel="stylesheet">
    
    <link href="/css/theme-workshop.css?1726390283" rel="stylesheet">
    
    

    <script src="/js/jquery-3.3.1.min.js?1726390283"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    
  </head>
  <body class="" data-url="/vi/3-ongoing-load---elt/">
    <nav id="sidebar" class="showVisitedLinks">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="/">

<svg id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 30" width="30%"><defs><style>.cls-1{fill:#fff;}.cls-2{fill:#f90;fill-rule:evenodd;}</style></defs><title>AWS-Logo_White-Color</title><path class="cls-1" d="M14.09,10.85a4.7,4.7,0,0,0,.19,1.48,7.73,7.73,0,0,0,.54,1.19.77.77,0,0,1,.12.38.64.64,0,0,1-.32.49l-1,.7a.83.83,0,0,1-.44.15.69.69,0,0,1-.49-.23,3.8,3.8,0,0,1-.6-.77q-.25-.42-.51-1a6.14,6.14,0,0,1-4.89,2.3,4.54,4.54,0,0,1-3.32-1.19,4.27,4.27,0,0,1-1.22-3.2A4.28,4.28,0,0,1,3.61,7.75,6.06,6.06,0,0,1,7.69,6.46a12.47,12.47,0,0,1,1.76.13q.92.13,1.91.36V5.73a3.65,3.65,0,0,0-.79-2.66A3.81,3.81,0,0,0,7.86,2.3a7.71,7.71,0,0,0-1.79.22,12.78,12.78,0,0,0-1.79.57,4.55,4.55,0,0,1-.58.22l-.26,0q-.35,0-.35-.52V2a1.09,1.09,0,0,1,.12-.58,1.2,1.2,0,0,1,.47-.35A10.88,10.88,0,0,1,5.77.32,10.19,10.19,0,0,1,8.36,0a6,6,0,0,1,4.35,1.35,5.49,5.49,0,0,1,1.38,4.09ZM7.34,13.38a5.36,5.36,0,0,0,1.72-.31A3.63,3.63,0,0,0,10.63,12,2.62,2.62,0,0,0,11.19,11a5.63,5.63,0,0,0,.16-1.44v-.7a14.35,14.35,0,0,0-1.53-.28,12.37,12.37,0,0,0-1.56-.1,3.84,3.84,0,0,0-2.47.67A2.34,2.34,0,0,0,5,11a2.35,2.35,0,0,0,.61,1.76A2.4,2.4,0,0,0,7.34,13.38Zm13.35,1.8a1,1,0,0,1-.64-.16,1.3,1.3,0,0,1-.35-.65L15.81,1.51a3,3,0,0,1-.15-.67.36.36,0,0,1,.41-.41H17.7a1,1,0,0,1,.65.16,1.4,1.4,0,0,1,.33.65l2.79,11,2.59-11A1.17,1.17,0,0,1,24.39.6a1.1,1.1,0,0,1,.67-.16H26.4a1.1,1.1,0,0,1,.67.16,1.17,1.17,0,0,1,.32.65L30,12.39,32.88,1.25A1.39,1.39,0,0,1,33.22.6a1,1,0,0,1,.65-.16h1.54a.36.36,0,0,1,.41.41,1.36,1.36,0,0,1,0,.26,3.64,3.64,0,0,1-.12.41l-4,12.86a1.3,1.3,0,0,1-.35.65,1,1,0,0,1-.64.16H29.25a1,1,0,0,1-.67-.17,1.26,1.26,0,0,1-.32-.67L25.67,3.64,23.11,14.34a1.26,1.26,0,0,1-.32.67,1,1,0,0,1-.67.17Zm21.36.44a11.28,11.28,0,0,1-2.56-.29,7.44,7.44,0,0,1-1.92-.67,1,1,0,0,1-.61-.93v-.84q0-.52.38-.52a.9.9,0,0,1,.31.06l.42.17a8.77,8.77,0,0,0,1.83.58,9.78,9.78,0,0,0,2,.2,4.48,4.48,0,0,0,2.43-.55,1.76,1.76,0,0,0,.86-1.57,1.61,1.61,0,0,0-.45-1.16A4.29,4.29,0,0,0,43,9.22l-2.41-.76A5.15,5.15,0,0,1,38,6.78a3.94,3.94,0,0,1-.83-2.41,3.7,3.7,0,0,1,.45-1.85,4.47,4.47,0,0,1,1.19-1.37A5.27,5.27,0,0,1,40.51.29,7.4,7.4,0,0,1,42.6,0a8.87,8.87,0,0,1,1.12.07q.57.07,1.08.19t.95.26a4.27,4.27,0,0,1,.7.29,1.59,1.59,0,0,1,.49.41.94.94,0,0,1,.15.55v.79q0,.52-.38.52a1.76,1.76,0,0,1-.64-.2,7.74,7.74,0,0,0-3.2-.64,4.37,4.37,0,0,0-2.21.47,1.6,1.6,0,0,0-.79,1.48,1.58,1.58,0,0,0,.49,1.18,4.94,4.94,0,0,0,1.83.92L44.55,7a5.08,5.08,0,0,1,2.57,1.6A3.76,3.76,0,0,1,47.9,11a4.21,4.21,0,0,1-.44,1.93,4.4,4.4,0,0,1-1.21,1.47,5.43,5.43,0,0,1-1.85.93A8.25,8.25,0,0,1,42.05,15.62Z"></path><path class="cls-2" d="M45.19,23.81C39.72,27.85,31.78,30,25,30A36.64,36.64,0,0,1,.22,20.57c-.51-.46-.06-1.09.56-.74A49.78,49.78,0,0,0,25.53,26.4,49.23,49.23,0,0,0,44.4,22.53C45.32,22.14,46.1,23.14,45.19,23.81Z"></path><path class="cls-2" d="M47.47,21.21c-.7-.9-4.63-.42-6.39-.21-.53.06-.62-.4-.14-.74,3.13-2.2,8.27-1.57,8.86-.83s-.16,5.89-3.09,8.35c-.45.38-.88.18-.68-.32C46.69,25.8,48.17,22.11,47.47,21.21Z"></path></svg>

</a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1726390283"></script>
<script type="text/javascript" src="/js/auto-complete.js?1726390283"></script>
<script type="text/javascript">
    
        var baseurl = "http:\/\/lingling1101.github.io\/\/vi";
    
</script>
<script type="text/javascript" src="/js/search.js?1726390283"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/vi/1-getting-started/" title="Bắt đầu" class="dd-item 
        
        
        
        ">
      <a href="/vi/1-getting-started/">
           <b> 1. </b> Bắt đầu
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/vi/2-table-design-and-load/" title="Thiết kế bảng và tải dữ liệu" class="dd-item 
        
        
        
        ">
      <a href="/vi/2-table-design-and-load/">
           <b> 2. </b> Thiết kế bảng và tải dữ liệu
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/vi/3-ongoing-load---elt/" title="Tải dữ liệu liên tục - ELT" class="dd-item 
        
        active
        
        ">
      <a href="/vi/3-ongoing-load---elt/">
           <b> 3. </b> Tải dữ liệu liên tục - ELT
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/vi/4-data-sharing/" title="Chia sẻ dữ liệu" class="dd-item 
        
        
        
        ">
      <a href="/vi/4-data-sharing/">
           <b> 4. </b> Chia sẻ dữ liệu
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/vi/5-machine-learning---redshift-ml/" title="Học máy - Redshift ML" class="dd-item 
        
        
        
        ">
      <a href="/vi/5-machine-learning---redshift-ml/">
           <b> 5. </b> Học máy - Redshift ML
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/vi/6-query-data-lake---redshift-spectrum/" title="Truy vấn Data Lake - Redshift Spectrum" class="dd-item 
        
        
        
        ">
      <a href="/vi/6-query-data-lake---redshift-spectrum/">
          <b>6. </b>Truy vấn Data Lake - Redshift Spectrum
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/vi/7-operations/" title="Các hoạt động" class="dd-item 
        
        
        
        ">
      <a href="/vi/7-operations/">
          <b>7. </b>Các hoạt động
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/vi/8-clean/" title="Xóa các tài nguyên" class="dd-item 
        
        
        
        ">
      <a href="/vi/8-clean/">
          <b>8. </b>Xóa các tài nguyên
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
         
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li> 
                  <a class="padding" href="http://awsstudygroup.com"><i class='fab fa-aws'></i> AWS Study Group - Blog</a>
              </li>
          
              <li> 
                  <a class="padding" href="https://www.facebook.com/groups/awsstudygroupfcj"><i class='fab fa-facebook'></i> AWS Study Group - Nhóm FB</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="prefooter">
      <hr/>
      <ul>
      
        <li>
          <a class="padding">
            <i class="fas fa-language fa-fw"></i>
          <div class="select-style">
            <select id="select-language" onchange="location = this.value;">
          
          
          
              
              
                  
                    
                    
                      <option id="en" value="http://lingling1101.github.io/3-ongoing-load---elt/">English</option>
                    
                  
              
                  
              
          
              
              
                  
              
                  
                    
                    
                      <option id="vi" value="http://lingling1101.github.io/vi/3-ongoing-load---elt/" selected>Tiếng Việt</option>
                    
                  
              
          
        </select>
        <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
          width="255px" height="255px" viewBox="0 0 255 255" style="enable-background:new 0 0 255 255;" xml:space="preserve">
          <g>
            <g id="arrow-drop-down">
              <polygon points="0,63.75 127.5,191.25 255,63.75 		" />
            </g>
          </g>
        </svg>
        </div>
        </a>
        </li>
      
      
      
        <li><a class="padding" href="#" data-clear-history-toggle=""><i class="fas fa-history fa-fw"></i> Clear History</a></li>
      
      </ul>
    </section>
    
    <section id="footer">
      <left>
    
     <b> Workshop</b> <br>
    <img src="https://hitwebcounter.com/counter/counter.php?page=7920860&style=0038&nbdigits=9&type=page&initCount=0" title="Migrate" Alt="web counter"   border="0" /></a>  <br>
     <b> <a href="https://cloudjourney.awsstudygroup.com/">Cloud Journey</a></b> <br>
    <img src="https://hitwebcounter.com/counter/counter.php?page=7830807&style=0038&nbdigits=9&type=page&initCount=0" title="Total CLoud Journey" Alt="web counter"   border="0"   />
     
</left>
<left>
    <br>
    <br>
        <b> Last Updated </b> <br>
        <i><font color=orange>31-08-2024</font></i>
    </left>
    <left>
        <br>
        <br>
            <b> Team </b> <br>
           
            <i> <a href="https://drive.google.com/drive/folders/1-JDjxDuFFq9Xwszz7REZ_kDzWDPtM1XS?usp=sharing"  style="color:orange">Nguyễn Thị Thùy Linh  </a> <br>
                
               
        </i>
        </left>

<script async defer src="https://buttons.github.io/buttons.js"></script>

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            <a href='/vi/'>Redshift Immersion Labs</a> > Tải dữ liệu liên tục - ELT
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#3-quá-trình-tải-liên-tục---elt"><strong>3. Quá trình tải liên tục - ELT</strong></a></li>
        <li><a href="#nội-dung"><strong>Nội dung</strong></a></li>
        <li><a href="#31-trước-khi-bắt-đầu"><strong>3.1 Trước khi bắt đầu</strong></a></li>
        <li><a href="#32-stored-procedures---tải-dữ-liệu-đang-diễn-ra"><strong>3.2 Stored Procedures - Tải dữ liệu đang diễn ra</strong></a></li>
        <li><a href="#33-stored-procedures---xử-lý-ngoại-lệ"><strong>3.3 Stored Procedures - Xử lý Ngoại lệ</strong></a></li>
        <li><a href="#34-nguyên-tử-atomic"><strong>3.4 Nguyên tử (Atomic)</strong></a></li>
        <li><a href="#35-không-nguyên-tử-non-atomic"><strong>3.5 Không nguyên tử (Non-atomic)</strong></a></li>
        <li><a href="#36-materialized-views"><strong>3.6 Materialized Views</strong></a></li>
        <li><a href="#37-tổng-hợp"><strong>3.7 Tổng hợp</strong></a></li>
        <li><a href="#38-hàm-người-dùng-định-nghĩa-user-defined-functions"><strong>3.8 Hàm người dùng định nghĩa (User Defined Functions)</strong></a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Tải dữ liệu liên tục - ELT
            </h1>
          

        



	<h3 id="3-quá-trình-tải-liên-tục---elt"><strong>3. Quá trình tải liên tục - ELT</strong></h3>
<h3 id="nội-dung"><strong>Nội dung</strong></h3>
<ul>
<li>Trước khi bắt đầu</li>
<li>Stored Procedures - Tải dữ liệu đang diễn ra</li>
<li>Stored Procedures - Xử lý ngoại lệ</li>
<li>Materialized Views</li>
<li>User Defined Functions</li>
<li>Trước khi kết thúc</li>
</ul>
<h3 id="31-trước-khi-bắt-đầu"><strong>3.1 Trước khi bắt đầu</strong></h3>
<p>Bản lab này giả định rằng bạn đã khởi chạy một điểm cuối Amazon Redshift Serverless. Nếu bạn chưa làm như vậy, vui lòng xem phần Bắt đầu và làm theo các hướng dẫn tại đó. Chúng ta sẽ sử dụng Amazon Redshift QueryEditorV2 cho bản lab này.</p>
<p>Với ETL, việc chuyển đổi dữ liệu diễn ra ở một máy chủ trung gian ETL trước khi nạp nó vào Data Warehouse. Sơ đồ sau minh họa quy trình làm việc của ETL:</p>
<p><img alt="image.png" src="/images/3/3-1.png"></p>
<p>Với ELT (Extract, Load, Transform), việc chuyển đổi dữ liệu diễn ra ngay trong kho dữ liệu mục tiêu thay vì cần một máy chủ trung gian ETL. Cách tiếp cận này tận dụng khả năng của các công cụ cơ sở dữ liệu Redshift hỗ trợ xử lý song song quy mô lớn (MPP). Sơ đồ sau minh họa quy trình làm việc của ELT:</p>
<p><img alt="image.png" src="/images/3/3-2.png"></p>
<h3 id="32-stored-procedures---tải-dữ-liệu-đang-diễn-ra"><strong>3.2 Stored Procedures - Tải dữ liệu đang diễn ra</strong></h3>
<p>Stored procedures thường được sử dụng để đóng gói logic cho việc chuyển đổi dữ liệu, xác thực dữ liệu, và logic đặc thù của doanh nghiệp. Bằng cách kết hợp nhiều bước SQL vào một stored procedure, bạn có thể giảm bớt số lần trao đổi giữa ứng dụng của bạn và cơ sở dữ liệu. Một stored procedure có thể bao gồm ngôn ngữ định nghĩa dữ liệu (DDL) và ngôn ngữ thao tác dữ liệu (DML) bên cạnh các truy vấn SELECT. Stored procedure không bắt buộc phải trả về giá trị. Bạn có thể sử dụng ngôn ngữ thủ tục PL/pgSQL, bao gồm các vòng lặp và biểu thức điều kiện, để điều khiển luồng logic.</p>
<p>Hãy xem cách bạn có thể tạo và gọi stored procedure trong Redshift. Mục tiêu ở đây là cập nhật gia tăng dữ liệu lineitem. Hãy thực thi truy vấn sau để tạo bảng lineitem staging:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">create</span> <span style="color:#a6e22e">table</span> <span style="color:#a6e22e">stage_lineitem</span> (
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">L_ORDERKEY</span> <span style="color:#a6e22e">bigint</span> <span style="color:#a6e22e">NOT</span> <span style="color:#a6e22e">NULL</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">L_PARTKEY</span> <span style="color:#a6e22e">bigint</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">L_SUPPKEY</span> <span style="color:#a6e22e">bigint</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">L_LINENUMBER</span> <span style="color:#a6e22e">integer</span> <span style="color:#a6e22e">NOT</span> <span style="color:#a6e22e">NULL</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">L_QUANTITY</span> <span style="color:#a6e22e">decimal</span>(<span style="color:#ae81ff">18</span>,<span style="color:#ae81ff">4</span>),
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">L_EXTENDEDPRICE</span> <span style="color:#a6e22e">decimal</span>(<span style="color:#ae81ff">18</span>,<span style="color:#ae81ff">4</span>),
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">L_DISCOUNT</span> <span style="color:#a6e22e">decimal</span>(<span style="color:#ae81ff">18</span>,<span style="color:#ae81ff">4</span>),
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">L_TAX</span> <span style="color:#a6e22e">decimal</span>(<span style="color:#ae81ff">18</span>,<span style="color:#ae81ff">4</span>),
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">L_RETURNFLAG</span> <span style="color:#a6e22e">varchar</span>(<span style="color:#ae81ff">1</span>),
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">L_LINESTATUS</span> <span style="color:#a6e22e">varchar</span>(<span style="color:#ae81ff">1</span>),
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">L_SHIPDATE</span> <span style="color:#a6e22e">date</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">L_COMMITDATE</span> <span style="color:#a6e22e">date</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">L_RECEIPTDATE</span> <span style="color:#a6e22e">date</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">L_SHIPINSTRUCT</span> <span style="color:#a6e22e">varchar</span>(<span style="color:#ae81ff">25</span>),
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">L_SHIPMODE</span> <span style="color:#a6e22e">varchar</span>(<span style="color:#ae81ff">10</span>),
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">L_COMMENT</span> <span style="color:#a6e22e">varchar</span>(<span style="color:#ae81ff">44</span>));
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-33.png"></p>
<p>Thực thi script dưới đây để tạo một stored procedure. Stored procedure này thực hiện các nhiệm vụ sau:</p>
<ol>
<li>Xóa sạch bảng staging để loại bỏ dữ liệu cũ.</li>
<li>Tải dữ liệu vào bảng <code>stage_lineitem</code> bằng lệnh <code>COPY</code>.</li>
<li>Hợp nhất các bản ghi được cập nhật vào bảng <code>lineitem</code> hiện có. Hàm <code>MERGE</code> sẽ cập nhật bảng đích dựa trên dữ liệu mới trong bảng staging.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">CREATE</span> <span style="color:#a6e22e">OR</span> <span style="color:#a6e22e">REPLACE</span> <span style="color:#a6e22e">PROCEDURE</span> <span style="color:#a6e22e">lineitem_incremental</span>()
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">AS</span> <span style="color:#a6e22e">$$</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">BEGIN</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">truncate</span> <span style="color:#a6e22e">stage_lineitem</span>;  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">copy</span> <span style="color:#a6e22e">stage_lineitem</span> <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;s3://redshift-immersionday-labs/data/lineitem/lineitem.tbl.340.lzo&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">iam_role</span> <span style="color:#66d9ef">default</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">region</span> <span style="color:#e6db74">&#39;us-west-2&#39;</span> <span style="color:#a6e22e">lzop</span> <span style="color:#a6e22e">delimiter</span> <span style="color:#e6db74">&#39;|&#39;</span> <span style="color:#a6e22e">COMPUPDATE</span> <span style="color:#a6e22e">PRESET</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">copy</span> <span style="color:#a6e22e">stage_lineitem</span> <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;s3://redshift-immersionday-labs/data/lineitem/lineitem.tbl.341.lzo&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">iam_role</span> <span style="color:#66d9ef">default</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">region</span> <span style="color:#e6db74">&#39;us-west-2&#39;</span> <span style="color:#a6e22e">lzop</span> <span style="color:#a6e22e">delimiter</span> <span style="color:#e6db74">&#39;|&#39;</span> <span style="color:#a6e22e">COMPUPDATE</span> <span style="color:#a6e22e">PRESET</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">copy</span> <span style="color:#a6e22e">stage_lineitem</span> <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;s3://redshift-immersionday-labs/data/lineitem/lineitem.tbl.342.lzo&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">iam_role</span> <span style="color:#66d9ef">default</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">region</span> <span style="color:#e6db74">&#39;us-west-2&#39;</span> <span style="color:#a6e22e">lzop</span> <span style="color:#a6e22e">delimiter</span> <span style="color:#e6db74">&#39;|&#39;</span> <span style="color:#a6e22e">COMPUPDATE</span> <span style="color:#a6e22e">PRESET</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">merge</span> <span style="color:#a6e22e">into</span> <span style="color:#a6e22e">lineitem</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">using</span> <span style="color:#a6e22e">stage_lineitem</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">on</span> <span style="color:#a6e22e">stage_lineitem</span>.<span style="color:#a6e22e">l_orderkey</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">lineitem</span>.<span style="color:#a6e22e">l_orderkey</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">and</span> <span style="color:#a6e22e">stage_lineitem</span>.<span style="color:#a6e22e">l_linenumber</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">lineitem</span>.<span style="color:#a6e22e">l_linenumber</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">remove</span> <span style="color:#a6e22e">duplicates</span>
</span></span><span style="display:flex;"><span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">END</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">$$</span> <span style="color:#a6e22e">LANGUAGE</span> <span style="color:#a6e22e">plpgsql</span>;
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-44.png"></p>
<p>Trước khi bạn gọi stored procedure này, hãy thu thập tổng số hàng từ bảng <code>lineitem</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">SELECT</span> <span style="color:#a6e22e">count</span>(<span style="color:#f92672">*</span>) <span style="color:#a6e22e">FROM</span> <span style="color:#e6db74">&#34;dev&#34;</span>.<span style="color:#e6db74">&#34;public&#34;</span>.<span style="color:#e6db74">&#34;lineitem&#34;</span>; <span style="color:#f92672">--</span><span style="color:#ae81ff">303008217</span>
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-5.png"></p>
<p>Gọi stored procedure này bằng cách sử dụng câu lệnh <code>CALL</code>. Khi thực thi, nó sẽ thực hiện một quá trình tải gia tăng:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">call</span> <span style="color:#a6e22e">lineitem_incremental</span>();
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-6.png"></p>
<p>Sau khi bạn gọi stored procedure này, hãy xác minh xem tổng số hàng trong bảng <code>lineitem</code> đã thay đổi hay chưa.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">SELECT</span> <span style="color:#a6e22e">count</span>(<span style="color:#f92672">*</span>) <span style="color:#a6e22e">FROM</span> <span style="color:#e6db74">&#34;dev&#34;</span>.<span style="color:#e6db74">&#34;public&#34;</span>.<span style="color:#e6db74">&#34;lineitem&#34;</span>; <span style="color:#f92672">--</span><span style="color:#ae81ff">306008217</span>
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-7.png"></p>
<h3 id="33-stored-procedures---xử-lý-ngoại-lệ"><strong>3.3 Stored Procedures - Xử lý Ngoại lệ</strong></h3>
<p>Phần tiếp theo đề cập đến việc xử lý ngoại lệ trong stored procedures. Stored procedures hỗ trợ xử lý ngoại lệ theo định dạng sau:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">Example</span> <span style="color:#a6e22e">pseudocode</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">BEGIN</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">statements</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">EXCEPTION</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">WHEN</span> <span style="color:#a6e22e">OTHERS</span> <span style="color:#a6e22e">THEN</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">statements</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">END</span>;
</span></span></code></pre></div><p>Các ngoại lệ được xử lý trong stored procedures khác nhau dựa trên chế độ nguyên tử (atomic) hoặc không nguyên tử (non-atomic) được chọn.</p>
<ul>
<li><strong>Nguyên tử (atomic) (mặc định):</strong> Các ngoại lệ (lỗi) luôn được đưa ra lại.</li>
<li><strong>Không nguyên tử (non-atomic):</strong> Các ngoại lệ được xử lý và bạn có thể chọn việc đưa ra lại hay không.</li>
</ul>
<blockquote>
<p><strong>Lưu ý:</strong> Khi gọi một stored procedure từ một stored procedure khác, các stored procedures phải có chế độ giao dịch (transaction mode) giống nhau, nếu không bạn sẽ thấy lỗi sau: &ldquo;Stored procedure created in one transaction mode cannot be invoked from another procedure in a different transaction mode.&rdquo;</p>
</blockquote>
<p>Để bắt đầu, chúng ta cần tạo một bảng cho các stored procedures trong phần này.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">CREATE</span> <span style="color:#a6e22e">TABLE</span> <span style="color:#a6e22e">stage_lineitem2</span> (<span style="color:#a6e22e">LIKE</span> <span style="color:#a6e22e">stage_lineitem</span>);
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-88.png"></p>
<p>Tiếp theo, chúng ta sẽ tạo một bảng để ghi lại các thông báo lỗi.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">CREATE</span> <span style="color:#a6e22e">TABLE</span> <span style="color:#a6e22e">procedure_log</span>
</span></span><span style="display:flex;"><span>(<span style="color:#a6e22e">log_timestamp</span> <span style="color:#a6e22e">timestamp</span>, <span style="color:#a6e22e">procedure_name</span> <span style="color:#a6e22e">varchar</span>(<span style="color:#ae81ff">100</span>), <span style="color:#a6e22e">error_message</span> <span style="color:#a6e22e">varchar</span>(<span style="color:#ae81ff">255</span>));
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-99.png"></p>
<h3 id="34-nguyên-tử-atomic"><strong>3.4 Nguyên tử (Atomic)</strong></h3>
<p>Các stored procedures trong Redshift mặc định là nguyên tử, điều này có nghĩa là bạn có quyền kiểm soát giao dịch cho các câu lệnh trong stored procedure. Nếu bạn chọn không bao gồm các lệnh</p>
<pre tabindex="0"><code>COMMIT
</code></pre><p>hoặc</p>
<pre tabindex="0"><code>ROLLBACK
</code></pre><p>trong stored procedure, thì tất cả các câu lệnh sẽ được xử lý trong một giao dịch duy nhất. Quan trọng là trong chế độ nguyên tử mặc định, các ngoại lệ luôn được đưa ra lại.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">CREATE</span> <span style="color:#a6e22e">OR</span> <span style="color:#a6e22e">REPLACE</span> <span style="color:#a6e22e">PROCEDURE</span> <span style="color:#a6e22e">pr_divide_by_zero</span>() <span style="color:#a6e22e">AS</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">$$</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">DECLARE</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">v_int</span> <span style="color:#66d9ef">int</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">BEGIN</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">v_int</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">EXCEPTION</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">WHEN</span> <span style="color:#a6e22e">OTHERS</span> <span style="color:#a6e22e">THEN</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">INSERT</span> <span style="color:#a6e22e">INTO</span> <span style="color:#a6e22e">procedure_log</span> <span style="color:#a6e22e">VALUES</span> (<span style="color:#a6e22e">getdate</span>(), <span style="color:#e6db74">&#39;pr_divide_by_zero&#39;</span>, <span style="color:#a6e22e">sqlerrm</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">RAISE</span> <span style="color:#a6e22e">INFO</span> <span style="color:#e6db74">&#39;pr_divide_by_zero: %&#39;</span>, <span style="color:#a6e22e">sqlerrm</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">END</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">$$</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">LANGUAGE</span> <span style="color:#a6e22e">plpgsql</span>;
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-010.png"></p>
<p>Stored procedure trên được thiết kế để gặp lỗi chia cho số 0. Xử lý ngoại lệ trong stored procedure này lưu trữ thông báo lỗi vào bảng <code>procedure_log</code> và sau đó thực hiện lệnh <code>RAISE INFO</code> để thông báo cho procedure gọi biết về lỗi. Vì đây là một procedure nguyên tử (atomic), điều này sẽ dẫn đến việc lỗi được đưa ra lại ngay cả khi khối ngoại lệ không đưa ra lỗi. Mặc dù nó chỉ đưa ra thông báo thông tin (INFO), Redshift sẽ ghi đè điều này ở chế độ mặc định và một lỗi (ERROR) sẽ được đưa ra.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">CREATE</span> <span style="color:#a6e22e">OR</span> <span style="color:#a6e22e">REPLACE</span> <span style="color:#a6e22e">PROCEDURE</span> <span style="color:#a6e22e">pr_insert_stage</span>() <span style="color:#a6e22e">AS</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">$$</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">BEGIN</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">TRUNCATE</span> <span style="color:#a6e22e">stage_lineitem2</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">INSERT</span> <span style="color:#a6e22e">INTO</span> <span style="color:#a6e22e">stage_lineitem2</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">FROM</span> <span style="color:#a6e22e">stage_lineitem</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">call</span> <span style="color:#a6e22e">pr_divide_by_zero</span>();
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">EXCEPTION</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">WHEN</span> <span style="color:#a6e22e">OTHERS</span> <span style="color:#a6e22e">THEN</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">RAISE</span> <span style="color:#a6e22e">EXCEPTION</span> <span style="color:#e6db74">&#39;pr_insert_stage: %&#39;</span>, <span style="color:#a6e22e">sqlerrm</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">END</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">$$</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">LANGUAGE</span> <span style="color:#a6e22e">plpgsql</span>;
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-011.png"></p>
<p>Quy trình được lưu trữ thứ hai này sẽ chèn dữ liệu vào bảng stage_lineitem2 rồi gọi quy trình sẽ bị lỗi theo thiết kế.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">CALL</span> <span style="color:#a6e22e">pr_insert_stage</span>();
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-012.png"></p>
<p>Bạn sẽ thấy hai thông báo:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">INFO</span><span style="color:#f92672">:</span>  <span style="color:#a6e22e">pr_divide_by_zero</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">division</span> <span style="color:#a6e22e">by</span> <span style="color:#a6e22e">zero</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ERROR</span><span style="color:#f92672">:</span>  <span style="color:#a6e22e">pr_insert_stage</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">division</span> <span style="color:#a6e22e">by</span> <span style="color:#a6e22e">zero</span>
</span></span></code></pre></div><p>Lưu ý rằng thông báo INFO là từ <code>pr_divide_by_zero</code>, trong khi lỗi (ERROR) là từ <code>pr_insert_stage</code>. Lỗi đã được tự động đưa ra lại, vì vậy <code>pr_insert_stage()</code> đã đưa ra lỗi (ERROR).</p>
<p>Bây giờ, hãy kiểm tra số lượng hàng trong bảng <code>stage_lineitem2</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">SELECT</span> <span style="color:#a6e22e">COUNT</span>(<span style="color:#f92672">*</span>) <span style="color:#a6e22e">FROM</span> <span style="color:#a6e22e">stage_lineitem2</span>;
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-13.png"></p>
<p>Vì stored procedure là nguyên tử (atomic), dữ liệu được chèn vào bảng stage đã bị hoàn tác (rolled back) do lỗi xảy ra sau đó, nên số lượng hàng trong bảng <code>stage_lineitem2</code> là bằng không.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">FROM</span> <span style="color:#a6e22e">procedure_log</span> <span style="color:#a6e22e">ORDER</span> <span style="color:#a6e22e">BY</span> <span style="color:#a6e22e">log_timestamp</span> <span style="color:#a6e22e">DESC</span>;
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-014.png"></p>
<p>Bạn sẽ thấy rằng lỗi thủ tục pr_divide_by_zero đã được ghi lại trong khối ngoại lệ.</p>
<h3 id="35-không-nguyên-tử-non-atomic"><strong>3.5 Không nguyên tử (Non-atomic)</strong></h3>
<p>Stored procedures cũng có thể được tạo với tùy chọn <code>NONATOMIC</code>, điều này sẽ tự động <code>COMMIT</code> sau mỗi câu lệnh. Khi xảy ra ngoại lệ lỗi (ERROR) trong một stored procedure, ngoại lệ không phải lúc nào cũng được đưa ra lại. Thay vào đó, bạn có thể chọn &ldquo;xử lý&rdquo; lỗi và tiếp tục các câu lệnh tiếp theo trong stored procedure.</p>
<p>Các stored procedures sau đây giống hệt với các phiên bản nguyên tử, ngoại trừ việc mỗi stored procedure bây giờ bao gồm tùy chọn <code>NONATOMIC</code>. Chế độ này tự động cam kết (commit) các câu lệnh bên trong procedure và không tự động đưa ra lại các lỗi.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">CREATE</span> <span style="color:#a6e22e">OR</span> <span style="color:#a6e22e">REPLACE</span> <span style="color:#a6e22e">PROCEDURE</span> <span style="color:#a6e22e">pr_divide_by_zero_v2</span>() <span style="color:#a6e22e">NONATOMIC</span> <span style="color:#a6e22e">AS</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">$$</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">DECLARE</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">v_int</span> <span style="color:#66d9ef">int</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">BEGIN</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">v_int</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">EXCEPTION</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">WHEN</span> <span style="color:#a6e22e">OTHERS</span> <span style="color:#a6e22e">THEN</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">INSERT</span> <span style="color:#a6e22e">INTO</span> <span style="color:#a6e22e">procedure_log</span> <span style="color:#a6e22e">VALUES</span> (<span style="color:#a6e22e">getdate</span>(), <span style="color:#e6db74">&#39;pr_divide_by_zero_v2&#39;</span>, <span style="color:#a6e22e">sqlerrm</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">RAISE</span> <span style="color:#a6e22e">INFO</span> <span style="color:#e6db74">&#39;pr_divide_by_zero_v2: %&#39;</span>, <span style="color:#a6e22e">sqlerrm</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">END</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">$$</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">LANGUAGE</span> <span style="color:#a6e22e">plpgsql</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">CREATE</span> <span style="color:#a6e22e">OR</span> <span style="color:#a6e22e">REPLACE</span> <span style="color:#a6e22e">PROCEDURE</span> <span style="color:#a6e22e">pr_insert_stage_v2</span>() <span style="color:#a6e22e">NONATOMIC</span> <span style="color:#a6e22e">AS</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">$$</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">BEGIN</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">TRUNCATE</span> <span style="color:#a6e22e">stage_lineitem2</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">INSERT</span> <span style="color:#a6e22e">INTO</span> <span style="color:#a6e22e">stage_lineitem2</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">FROM</span> <span style="color:#a6e22e">stage_lineitem</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">call</span> <span style="color:#a6e22e">pr_divide_by_zero_v2</span>();
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">EXCEPTION</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">WHEN</span> <span style="color:#a6e22e">OTHERS</span> <span style="color:#a6e22e">THEN</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">RAISE</span> <span style="color:#a6e22e">EXCEPTION</span> <span style="color:#e6db74">&#39;pr_insert_stage_v2: %&#39;</span>, <span style="color:#a6e22e">sqlerrm</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">END</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">$$</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">LANGUAGE</span> <span style="color:#a6e22e">plpgsql</span>;
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-015.png"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">CALL</span> <span style="color:#a6e22e">pr_insert_stage_v2</span>();
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-16.png"></p>
<p>Bạn sẽ nhận được thông báo:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">INFO</span><span style="color:#f92672">:</span>  <span style="color:#a6e22e">pr_divide_by_zero</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">division</span> <span style="color:#a6e22e">by</span> <span style="color:#a6e22e">zero</span>
</span></span></code></pre></div><p>Hãy nhớ rằng trong chế độ nguyên tử mặc định, bạn đã thấy hai thông báo, trong khi ở chế độ này, lỗi (ERROR) đã được xử lý và ngoại lệ không được đưa ra lại.</p>
<p>Bây giờ, hãy kiểm tra số lượng hàng trong bảng <code>stage_lineitem2</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">SELECT</span> <span style="color:#a6e22e">COUNT</span>(<span style="color:#f92672">*</span>) <span style="color:#a6e22e">FROM</span> <span style="color:#a6e22e">stage_lineitem2</span>;
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-017.png"></p>
<p>Vì stored procedure là không nguyên tử (non-atomic), dữ liệu được chèn vào bảng không bị hoàn tác. Câu lệnh chèn đã được tự động cam kết. Số lượng hàng trong bảng <code>stage_lineitem2</code> là 4,155,141.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">FROM</span> <span style="color:#a6e22e">procedure_log</span> <span style="color:#a6e22e">ORDER</span> <span style="color:#a6e22e">BY</span> <span style="color:#a6e22e">log_timestamp</span> <span style="color:#a6e22e">DESC</span>;
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-018.png"></p>
<p>Bạn sẽ thấy rằng lỗi thủ tục pr_divide_by_zero_v2 đã được ghi lại trong khối ngoại lệ giống như trong phiên bản nguyên tử.</p>
<h3 id="36-materialized-views"><strong>3.6 Materialized Views</strong></h3>
<p>Trong môi trường kho dữ liệu, các ứng dụng thường cần thực hiện các truy vấn phức tạp trên các bảng lớn—ví dụ, các câu lệnh SELECT thực hiện các phép nối nhiều bảng và tổng hợp dữ liệu trên các bảng chứa hàng tỷ hàng. Việc xử lý các truy vấn này có thể tốn kém về mặt tài nguyên hệ thống và thời gian để tính toán kết quả.</p>
<p>Materialized views trong Amazon Redshift cung cấp một cách để giải quyết các vấn đề này. Materialized view chứa một tập hợp kết quả đã được tính toán trước, dựa trên truy vấn SQL trên một hoặc nhiều bảng cơ sở. Tại đây, bạn sẽ học cách tạo, truy vấn và làm mới (refresh) một materialized view.</p>
<p>Hãy lấy một ví dụ khi bạn muốn tạo một báo cáo về các nhà cung cấp hàng đầu dựa trên số lượng hàng đã giao. Truy vấn này sẽ kết hợp các bảng lớn như <code>lineitem</code> và <code>suppliers</code> và quét một lượng dữ liệu lớn. Bạn có thể viết một truy vấn như sau:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">select</span> <span style="color:#a6e22e">n_name</span>, <span style="color:#a6e22e">s_name</span>, <span style="color:#a6e22e">l_shipmode</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">SUM</span>(<span style="color:#a6e22e">L_QUANTITY</span>) <span style="color:#a6e22e">Total_Qty</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">from</span> <span style="color:#a6e22e">lineitem</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">join</span> <span style="color:#a6e22e">supplier</span> <span style="color:#a6e22e">on</span> <span style="color:#a6e22e">l_suppkey</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_suppkey</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">join</span> <span style="color:#a6e22e">nation</span> <span style="color:#a6e22e">on</span> <span style="color:#a6e22e">s_nationkey</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">n_nationkey</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">where</span> <span style="color:#a6e22e">datepart</span>(<span style="color:#a6e22e">year</span>, <span style="color:#a6e22e">L_SHIPDATE</span>) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1997</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">group</span> <span style="color:#a6e22e">by</span> <span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">order</span> <span style="color:#a6e22e">by</span> <span style="color:#ae81ff">3</span> <span style="color:#a6e22e">desc</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">limit</span> <span style="color:#ae81ff">1000</span>;
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-19.png"></p>
<p>Truy vấn này mất thời gian để thực thi và vì nó đang quét một lượng lớn dữ liệu nên sẽ sử dụng nhiều tài nguyên I/O và CPU. Hãy tưởng tượng một tình huống mà nhiều người dùng trong tổ chức cần lấy các chỉ số ở mức nhà cung cấp như trên. Mỗi người có thể viết các truy vấn nặng tương tự, điều này có thể tốn thời gian và tốn kém. Thay vì làm như vậy, bạn có thể sử dụng một materialized view để lưu trữ các kết quả đã được tính toán trước, giúp tăng tốc cho các truy vấn có thể dự đoán và lặp lại.</p>
<p>Amazon Redshift cung cấp một số phương pháp để giữ cho các materialized views luôn được cập nhật. Bạn có thể cấu hình tùy chọn tự động làm mới (auto refresh) để làm mới các materialized views khi các bảng cơ sở được cập nhật. Quá trình tự động làm mới sẽ chạy vào thời điểm khi tài nguyên của cụm sẵn có để giảm thiểu sự gián đoạn cho các tác vụ khác.</p>
<p>Thực hiện truy vấn dưới đây để tạo một materialized view, trong đó tổng hợp dữ liệu từ bảng <code>lineitem</code> theo mức nhà cung cấp. Lưu ý rằng tùy chọn <code>AUTO REFRESH</code> được đặt thành <code>YES</code> và chúng tôi đã bao gồm các cột bổ sung trong materialized view để các người dùng khác có thể tận dụng dữ liệu đã được tổng hợp này.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">CREATE</span> <span style="color:#a6e22e">MATERIALIZED</span> <span style="color:#a6e22e">VIEW</span> <span style="color:#a6e22e">supplier_shipmode_agg</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">AUTO</span> <span style="color:#a6e22e">REFRESH</span> <span style="color:#a6e22e">YES</span> <span style="color:#a6e22e">AS</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">select</span> <span style="color:#a6e22e">l_suppkey</span>, <span style="color:#a6e22e">l_shipmode</span>, <span style="color:#a6e22e">datepart</span>(<span style="color:#a6e22e">year</span>, <span style="color:#a6e22e">L_SHIPDATE</span>) <span style="color:#a6e22e">l_shipyear</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">SUM</span>(<span style="color:#a6e22e">L_QUANTITY</span>)	<span style="color:#a6e22e">TOTAL_QTY</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">SUM</span>(<span style="color:#a6e22e">L_DISCOUNT</span>) <span style="color:#a6e22e">TOTAL_DISCOUNT</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">SUM</span>(<span style="color:#a6e22e">L_TAX</span>) <span style="color:#a6e22e">TOTAL_TAX</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">SUM</span>(<span style="color:#a6e22e">L_EXTENDEDPRICE</span>) <span style="color:#a6e22e">TOTAL_EXTENDEDPRICE</span>  
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">from</span> <span style="color:#a6e22e">LINEITEM</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">group</span> <span style="color:#a6e22e">by</span> <span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span>;
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-0020.png"></p>
<p>Bây giờ hãy thực hiện truy vấn bên dưới đã được viết lại để sử dụng chế độ xem cụ thể hóa. Lưu ý sự khác biệt về thời gian thực hiện truy vấn. Bạn nhận được kết quả tương tự trong vài giây.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">select</span> <span style="color:#a6e22e">n_name</span>, <span style="color:#a6e22e">s_name</span>, <span style="color:#a6e22e">l_shipmode</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">SUM</span>(<span style="color:#a6e22e">TOTAL_QTY</span>) <span style="color:#a6e22e">Total_Qty</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">from</span> <span style="color:#a6e22e">supplier_shipmode_agg</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">join</span> <span style="color:#a6e22e">supplier</span> <span style="color:#a6e22e">on</span> <span style="color:#a6e22e">l_suppkey</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_suppkey</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">join</span> <span style="color:#a6e22e">nation</span> <span style="color:#a6e22e">on</span> <span style="color:#a6e22e">s_nationkey</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">n_nationkey</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">where</span> <span style="color:#a6e22e">l_shipyear</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1997</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">group</span> <span style="color:#a6e22e">by</span> <span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">order</span> <span style="color:#a6e22e">by</span> <span style="color:#ae81ff">3</span> <span style="color:#a6e22e">desc</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">limit</span> <span style="color:#ae81ff">1000</span>;
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-21.png"></p>
<p>Một tính năng mạnh mẽ khác của materialized view là khả năng tự động viết lại truy vấn (auto query rewrite). Amazon Redshift có thể tự động viết lại các truy vấn để sử dụng materialized view, ngay cả khi truy vấn không tham chiếu rõ ràng đến materialized view.</p>
<p>Bây giờ, hãy chạy lại truy vấn gốc của bạn, truy vấn này tham chiếu đến bảng <code>lineitem</code>, và xem truy vấn này thực thi nhanh hơn vì Redshift đã viết lại truy vấn để tận dụng materialized view thay vì bảng cơ sở.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">select</span> <span style="color:#a6e22e">n_name</span>, <span style="color:#a6e22e">s_name</span>, <span style="color:#a6e22e">l_shipmode</span>, <span style="color:#a6e22e">SUM</span>(<span style="color:#a6e22e">L_QUANTITY</span>) <span style="color:#a6e22e">Total_Qty</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">from</span> <span style="color:#a6e22e">lineitem</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">join</span> <span style="color:#a6e22e">supplier</span> <span style="color:#a6e22e">on</span> <span style="color:#a6e22e">l_suppkey</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_suppkey</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">join</span> <span style="color:#a6e22e">nation</span> <span style="color:#a6e22e">on</span> <span style="color:#a6e22e">s_nationkey</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">n_nationkey</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">where</span> <span style="color:#a6e22e">datepart</span>(<span style="color:#a6e22e">year</span>, <span style="color:#a6e22e">L_SHIPDATE</span>) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1997</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">group</span> <span style="color:#a6e22e">by</span> <span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">order</span> <span style="color:#a6e22e">by</span> <span style="color:#ae81ff">3</span> <span style="color:#a6e22e">desc</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">limit</span> <span style="color:#ae81ff">1000</span>;
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-22.png"></p>
<p>Bạn có thể xác minh rằng người viết lại truy vấn đang sử dụng MV bằng cách chạy thao tác giải thích:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">explain</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">select</span> <span style="color:#a6e22e">n_name</span>, <span style="color:#a6e22e">s_name</span>, <span style="color:#a6e22e">l_shipmode</span>, <span style="color:#a6e22e">SUM</span>(<span style="color:#a6e22e">L_QUANTITY</span>) <span style="color:#a6e22e">Total_Qty</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">from</span> <span style="color:#a6e22e">lineitem</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">join</span> <span style="color:#a6e22e">supplier</span> <span style="color:#a6e22e">on</span> <span style="color:#a6e22e">l_suppkey</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">s_suppkey</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">join</span> <span style="color:#a6e22e">nation</span> <span style="color:#a6e22e">on</span> <span style="color:#a6e22e">s_nationkey</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">n_nationkey</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">where</span> <span style="color:#a6e22e">datepart</span>(<span style="color:#a6e22e">year</span>, <span style="color:#a6e22e">L_SHIPDATE</span>) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1997</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">group</span> <span style="color:#a6e22e">by</span> <span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">order</span> <span style="color:#a6e22e">by</span> <span style="color:#ae81ff">3</span> <span style="color:#a6e22e">desc</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">limit</span> <span style="color:#ae81ff">1000</span>;
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-23.png"></p>
<p><img alt="image.png" src="/images/3/3-232.png"></p>
<blockquote>
<p>Viết các truy vấn bổ sung có thể tận dụng chế độ xem được thực thể hóa của bạn nhưng không tham chiếu trực tiếp đến nó. Ví dụ: Tổng giá mở rộng theo khu vực.</p>
</blockquote>
<h3 id="37-tổng-hợp"><strong>3.7 Tổng hợp</strong></h3>
<p>Hãy xem liệu Redshift có tự động làm mới materialized view sau khi dữ liệu bảng <code>lineitem</code> thay đổi không.</p>
<p>Vui lòng thu thập một chỉ số sử dụng materialized view. Chúng ta sẽ so sánh giá trị này sau khi dữ liệu của bảng cơ sở thay đổi.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">select</span> <span style="color:#a6e22e">SUM</span>(<span style="color:#a6e22e">TOTAL_QTY</span>) <span style="color:#a6e22e">Total_Qty</span> <span style="color:#a6e22e">from</span> <span style="color:#a6e22e">supplier_shipmode_agg</span>;
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-24.png"></p>
<p>Hãy xóa một số dữ liệu đã tải trước đó khỏi bảng  <em>lineitem</em>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#66d9ef">delete</span> <span style="color:#a6e22e">from</span> <span style="color:#a6e22e">lineitem</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">using</span> <span style="color:#a6e22e">orders</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">where</span> <span style="color:#a6e22e">l_orderkey</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">o_orderkey</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">and</span> <span style="color:#a6e22e">datepart</span>(<span style="color:#a6e22e">year</span>, <span style="color:#a6e22e">o_orderdate</span>) <span style="color:#f92672">=</span> <span style="color:#ae81ff">1998</span> <span style="color:#a6e22e">and</span> <span style="color:#a6e22e">datepart</span>(<span style="color:#a6e22e">month</span>, <span style="color:#a6e22e">o_orderdate</span>) <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>;
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-25.png"></p>
<p>Chạy các truy vấn dưới đây trên materialized view và so sánh với giá trị bạn đã ghi lại trước đó. Bạn sẽ thấy giá trị tổng (SUM) đã thay đổi, điều này cho thấy Redshift đã nhận diện các thay đổi đã xảy ra trong bảng cơ sở hoặc các bảng cơ sở, và sau đó áp dụng các thay đổi đó vào materialized view.</p>
<blockquote>
<p><strong>Lưu ý:</strong> Việc làm mới materialized view là bất đồng bộ (asynchronous). Trong bài lab này, hãy dự đoán khoảng 5 phút để dữ liệu được làm mới sau khi bạn gọi stored procedure <code>lineitem_incremental</code>.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">select</span> <span style="color:#a6e22e">SUM</span>(<span style="color:#a6e22e">TOTAL_QTY</span>) <span style="color:#a6e22e">Total_Qty</span> <span style="color:#a6e22e">from</span> <span style="color:#a6e22e">supplier_shipmode_agg</span>;
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-26.png"></p>
<h3 id="38-hàm-người-dùng-định-nghĩa-user-defined-functions"><strong>3.8 Hàm người dùng định nghĩa (User Defined Functions)</strong></h3>
<p>Redshift hỗ trợ hàm người dùng định nghĩa (UDF) kiểu scalar bằng cách sử dụng câu lệnh SQL SELECT hoặc chương trình Python. Ví dụ dưới đây tạo một hàm Python so sánh hai số và trả về giá trị lớn hơn:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">create</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">f_py_greater</span> (<span style="color:#a6e22e">a</span> <span style="color:#66d9ef">float</span>, <span style="color:#a6e22e">b</span> <span style="color:#66d9ef">float</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">returns</span> <span style="color:#66d9ef">float</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">stable</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">as</span> <span style="color:#a6e22e">$$</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">a</span> <span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">b</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">a</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">b</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">$$</span> <span style="color:#a6e22e">language</span> <span style="color:#a6e22e">plpythonu</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">select</span> <span style="color:#a6e22e">f_py_greater</span> (<span style="color:#a6e22e">l_extendedprice</span>, <span style="color:#a6e22e">l_discount</span>) <span style="color:#a6e22e">from</span> <span style="color:#a6e22e">lineitem</span> <span style="color:#a6e22e">limit</span> <span style="color:#ae81ff">10</span>
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-272.png">
<img alt="image.png" src="/images/3/3-27.png">
Ví dụ sau đây tạo hàm SQL so sánh hai số và trả về giá trị lớn hơn:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">create</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">f_sql_greater</span> (<span style="color:#66d9ef">float</span>, <span style="color:#66d9ef">float</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">returns</span> <span style="color:#66d9ef">float</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">stable</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">as</span> <span style="color:#a6e22e">$$</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">select</span> <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">when</span> <span style="color:#a6e22e">$1</span> <span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">$2</span> <span style="color:#a6e22e">then</span> <span style="color:#a6e22e">$1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">$2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">end</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">$$</span> <span style="color:#a6e22e">language</span> <span style="color:#a6e22e">sql</span>;  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">select</span> <span style="color:#a6e22e">f_sql_greater</span> (<span style="color:#a6e22e">l_extendedprice</span>, <span style="color:#a6e22e">l_discount</span>) <span style="color:#a6e22e">from</span> <span style="color:#a6e22e">lineitem</span> <span style="color:#a6e22e">limit</span> <span style="color:#ae81ff">10</span>
</span></span></code></pre></div><p><img alt="image.png" src="/images/3/3-28.png"></p>





<footer class=" footline" >
	
</footer>

        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
        
        


	 
	 
		
			<a class="nav nav-prev" href="/vi/2-table-design-and-load/" title="Thiết kế bảng và tải dữ liệu"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="/vi/4-data-sharing/" title="Chia sẻ dữ liệu" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1726390283"></script>
    <script src="/js/perfect-scrollbar.min.js?1726390283"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1726390283"></script>
    <script src="/js/jquery.sticky.js?1726390283"></script>
    <script src="/js/featherlight.min.js?1726390283"></script>
    <script src="/js/highlight.pack.js?1726390283"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom-3.6.0.js?1726390283"></script>
    <script src="/js/learn.js?1726390283"></script>
    <script src="/js/hugo-learn.js?1726390283"></script>

    <link href="/mermaid/mermaid.css?1726390283" rel="stylesheet" />
    <script src="/mermaid/mermaid.js?1726390283"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-158079754-2', 'auto');
  ga('send', 'pageview');

</script>
  </body>
</html>
